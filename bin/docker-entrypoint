#!/bin/bash
# bin/docker-entrypoint

set -e

# 本番環境では環境変数の設定が必須
if [ "$RAILS_ENV" = "production" ]; then
  if [ -z "$SECRET_KEY_BASE" ]; then
    echo "ERROR: SECRET_KEY_BASE environment variable is required in production"
    exit 1
  fi
  
  if [ -z "$RAILS_MASTER_KEY" ]; then
    echo "ERROR: RAILS_MASTER_KEY environment variable is required in production"
    exit 1
  fi
fi

# 既存のserver.pidを削除
rm -f /rails/tmp/pids/server.pid

# データベース設定
if [ -f /rails/db/structure.sql ]; then
  ./bin/rails db:structure:load
else
  ./bin/rails db:migrate
fi

exec "$@"
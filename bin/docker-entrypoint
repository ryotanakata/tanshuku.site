#!/bin/bash
# bin/docker-entrypoint

set -e

# 環境変数デバッグ情報
echo "=== Environment Debug Info ==="
echo "RAILS_ENV: $RAILS_ENV"
echo "SECRET_KEY_BASE: ${SECRET_KEY_BASE:0:20}... (length: ${#SECRET_KEY_BASE})"
echo "RAILS_MASTER_KEY: ${RAILS_MASTER_KEY:0:10}... (length: ${#RAILS_MASTER_KEY})"
echo "=============================="

# 本番環境での環境変数チェック
if [ "$RAILS_ENV" = "production" ]; then
  if [ -z "$SECRET_KEY_BASE" ]; then
    echo "ERROR: SECRET_KEY_BASE environment variable is required in production"
    echo "Please set SECRET_KEY_BASE in Railway variables"
    echo "Available environment variables:"
    env | grep -E "(SECRET|RAILS)" | sort
    exit 1
  fi
  
  if [ -z "$RAILS_MASTER_KEY" ]; then
    echo "ERROR: RAILS_MASTER_KEY environment variable is required in production" 
    echo "Please set RAILS_MASTER_KEY in Railway variables"
    echo "Available environment variables:"
    env | grep -E "(SECRET|RAILS)" | sort
    exit 1
  fi
fi

# 既存のserver.pidを削除
rm -f /rails/tmp/pids/server.pid

# データベース設定
if [ -f /rails/db/structure.sql ]; then
  ./bin/rails db:structure:load
else
  ./bin/rails db:migrate
fi

exec "$@"